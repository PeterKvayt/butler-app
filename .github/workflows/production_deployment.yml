name: Production CI/CD
run-name: Deploy ðŸš€ to ${{ inputs.deploy_target }} by @${{ github.actor }} 
on:
  push:
    branches: [main]
jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Pull the repo
      uses: actions/checkout@v5
    - name: Setup secrets
      # env:
      #   APP_SECRET: ${{ secrets.TEST_SECRET }}
      run: |
        $configFile = "src/Api/appsettings.json"
        $content = Get-Content $configFile -Raw
        $content = $content -replace '#\{APP_SECRET\}#', '${{ secrets.TEST_SECRET }}'
        $content | Set-Content $configFile
        Get-Content $configFile
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 10.0.102
    - name: Dotnet info
      run: dotnet --info
    - name: Restore
      run: dotnet restore
    # cache restore if not exists https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax#jobsjob_idstepsif
    # - name: Cache restore
    #   uses: actions/cache@v4
    #   with:
    #     path: |
    #       ~/.gradle/caches
    #       ~/.gradle/wrapper
    - name: Build
      run: dotnet build --no-restore -c Release
    - name: Publish
      run: dotnet publish src/Api/Api.csproj -o src/Api/bin/publish -c Release -v n --no-build
    - name: Deploy to FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.6
      with:
        server: ${{ vars.SERVER_URL }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./src/Api/bin/publish/ # directory with artifacts from prev step
        server-dir: ${{ vars.SERVER_DIR }}